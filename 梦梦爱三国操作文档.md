#梦梦爱三国架构
###一、各个服务运行之间的联系
####1.认识梦梦爱三国
《梦梦爱三国》是一款策略性极强的卡牌类手游，500余位经典梦三英雄、2000+华丽技能带来新一代MOBA卡牌体验。
目前支持ios和Android版，同时在海外台湾也有相应的版本。
####2.首先认识这几种服务
|服务名称 | 服务作用 | 具体作用|
| -----|:----:| :----:|
|Client             |客户端| 用户手机使用的客户端软件
| HttpServer    | Http服务   | HTTP协议，用于充值
| LoginServer   | 登录服务    | 玩家登陆服务器
| GlobalServer  |  全局服务   | 其他WorldServer通讯的服务
| WholeServer   | 跨服战服务  | 负责不同大区之间的玩家进行连接
| **WorldServer**       | 游戏大区服务 | 负责与GS和数据服务进行连接
| **DBServer**          | 数据库服务   |负责和Mysql数据库连接
| **SharedMemory**      | 共享内存服务 |和DBServer连接，保证其正常运行
| **DBLogServer**       | 数据日志服务 |日志会写到数据库的服务
| **TownServer01/02/03**|城镇服务1/2/3 |城镇服务器，和玩家客户端的连接

``PS：以上加粗服务名称为日常大区必备7个服务。``

* **Client**
  
用户的手机客户端，将游戏的内容直观的显示给玩家。
运作方式为，用户通过各种渠道：应用商店，应用宝，AppStore上进行下载安装。
我们将客户端客户端放置在CDN上，提供玩家通过不同的渠道进行下载。
而且会根据渠道来分配不同的客户端类型，上传的目录也会不同。
国服一般是网宿CDN，台湾也有相应的CDN

* **HttpServer**

HS是用于http协议上的服务，用于用户的充值，以及活动相关的数据获取，传递给GS，然后再指定给大区WS，再写到到用户数据。
这样就完成了用户充值，活动道具获取。

* **LoginServer**

LS时登录服务器，用户登录大区是经过它来中转，用户在客户端选择登录界面是在LS上进行执行的，用户选择某一个大区后，LS通知对应的大区的TS，TS返回相应的端口以及IP地址给LS，然后LS告诉客户端IP和端口，这样客户端就能连接对应的TS,进行游戏了。

* **GlobalServer**

这是全局服务，负责整个游戏大区的运行，它统筹个个大区运行情况 和分发消息到各个大区。
例如用户充值，活动，等各个信息，全部都由GS来调度，分配给各个大区的WS，告知用户充值情况，
写入数据库中。
以上三个服务目前都在一台机器上运行。

* **WholeServer**

这个是跨服战服务，它主要是连接不同渠道，不同大区之间的玩家进行比赛。跨服战在单独的一台服务器上，在每个大区的WS配置文件中都已经定义好了WholeServer的IP地址和端口，当要开启跨服战的时候，GS和WS读取配置信息，进行连接。

* **WorldServer**
WS是一个大区的核心，大区内的所有逻辑运算，用户操作行为等，都是由WS来完成的。然后WS将用户所有操作的运算结果数据存储在DBS和DBLS中，
来完成整个游戏的整体调度。
* **DBServer**

DBS是用来调用Mysql服务，由WS进行控制，具体由DBS操作，进行所有数据的读写。
数据库也是单独在一台指定的服务器中，在创建大区的时候，会创建数据库。
* **SharedMemory**

SM是共享内存，是用来支撑DBServer的运行，万一DBS挂掉，SM有重启机制，进行重启服务。

* **DBLogServer**

这个服务于DBS服务类似，也是进行数据的读写，在用户登录之后开始记录用户的动作，行为，输出到日志中。

* **TownServer01/02/03**

TS在每个大区中标配有三个，配置信息大致相同，只有对应的端口不同。TS可以看成是大区的DNS,当用户登录到LS进行大区选择时，LS联系对应大区的TS，TS将自己的IP和端口告知LS，然后LS发送给用户客户端，用户进行连接，登录游戏，然后用户的连接状态一直是在TS中保存，然后被WS进行下面的操作。
####3.各个服务之间的工作机制
首先LS用于客户端登陆，用户登录后进入LS，发送数据告知GS连接的哪个大区，然后HS连接GS主要用于充值服务。LS进行具体分配用户到哪个大区，用户选择大区后，相应大区的TS会发送数据给LS,告知IP,端口，然后进入到相应大区的TS，然后WS大区服务连接的DBS开启数据库记录，以及调用DBLog进行记录用户所有操作的日志。这里的WS是大区的核心，所有的逻辑运算都在这里面。这里面的DBS会直接跟SharedMemory连，SharedMemory会根据DBS的运行情况来控制所需内存大小，来保障DBS的正常运行。这里面会有一个WholeServer，跨服战用到的服务，他主要是跟
GS和WS连接，用于不同大区之间的连接，形成跨服战。

####4.用户登陆到下线流程
下面用一张图来说明各个服务直接的联系。

![关系](https://ooo.0o0.ooo/2016/04/25/571decc7cb4f6.png)

各个服务的流程关系，如上图所示，里面的具体运算这里就不细说了。

####5.每个服务的都有哪些东西
* 以上的多种服务，最后放到服务器中运行起来，每个服务其实是一个文件夹，里面有服务运行的软件，动态链接库文件。
还有对于运维这边最主要的文件就是每个服务在**Data目录下以ini结尾的配置文件**，这里面包含着程序所要读取各种配置信息。
* Client（客户端）是针对于玩家手机端的下载，更新。客户端对于运维来说，只是一个软件包，上传至CDN，生成链接，提供玩家正常下载更新。

配置着服务在服务器上对应的端口，存放日志的路径。
####6.特殊服务说明
梦梦爱三国中有个跨服战,主要用于不同大区之间的玩家进行游戏。WholeServer主要连接不同大区的WS和GS进行关联。
WholeServer服务的跟其他服务在机器中存在形式是一样的，主要也是配置文件的修改，然后实现连接不同的大区。

---
###二、梦梦所有服务大区结构
####1.国服方面
||国服 |
|-----|:----:|:----:|
|服务端           |GS端         | 客户端（Client）|
|技术封测区       |HttpServer   |腾讯
|全混服           |LoginServer  |混服
|AppStore        |GlobalServer |AppStore
|AppStore审核服   |-----------------|技测
|跨服战           |-----------------|--------------
|服务端大区共251个 |HS，LS，GS公用一台|网宿CDN
|实体服务器12台    |IP:182.92.155.115|IP : wsfdupload.lxdns.com
由于大区太多，不一一列举。

从上面列表可以看出，国服大致分成三个方面：``客户端，服务端，GS端``。
不同的服务端里面包括很多大区。一般都会有一个渠道名，大区名，大区ID。
GS端是是三个服务LS，HS，GS，在同一台机器上。
####2.台湾方面
||台服 |
|-----|:----:|:----:|
|服务端         |GS端         | 客户端（Client）|
|台湾飞流       |HttpServer   |台湾飞流CDN
|AppStore审核服 |LoginServer  |--------------
|跨服战         |GlobalServer |--------------
|台湾测试       | HS，LS，GS公用一台  |--------------
| 实体服务器三台 |IP:203.69.246.37   |
台湾方面的也是一样，分为三个方面。

---
###三、我们运维需要做什么 
####1.单个服务器业务总体流程
* 机器初始化
* 安装业务，就是服务端所需服务
* 新开大区，内测，删档
* 对用户外开放大区
* 日常更新 （1）停服更新 （2不停服更新）
* 服务全部关闭，重启


**从准备机器开始，一直到后期维护，都是我们需要做的。**

**要知道的重要文件及脚本：
梦梦爱三国所有大区信息，对应的IP地址，渠道类型，业务类型，都在跳板机的``/data/msy/list/meng.all.list``中。（重要文件）
梦梦爱三国的服务端更新脚本在``/data/msy/``中。**
####2.准备机器 
* 机器初始化，这方面的文档在ido上有详细介绍。（http://git.om.dianhun.cn/yunwei/base/blob/master/%E4%B8%BB%E6%9C%BA%E5%88%9D%E5%A7%8B%E5%8C%96.md）
* 初始化主要是对服务器安装监控客户端，确保机器能在zabbix1，zabbix2和CC系统检测到。然后搭建业务常用的环境。

####3.开新大区，内测，删档，对外开放。
我们已经了解所有的服务，开新大区主要是将第一部分提到的： 
> ``PS：以上加粗服务名称为日常大区必备7个服务。``

这7个服务一般是一个大区的标配。然后我们来创建大区。

* 确定好大区要创建在哪个服务器上，获取IP地址。
* 将相应的服务文件拷贝上去
* 然后修改每个服务目录下的ini配置文件。
* 开启服务，查看服务运行状态，端口开通情况，防火墙配置等。
* 确认服务开启后，联系产品方面进行测试
* 测试无误后，删档
* 等待产品发起开服流程，然后开放对外。
这样一个完整的大区就创建结束了，用户也可以在客户端登录此界面。
然而这样一个个手动修改服务，开启服务，删档，太浪费时间，于是通过脚本批量修改。
梦梦开大区的具体流程，可以参照我写的武神赵子龙新开大区的文档，只是个别脚本不同，原理相同。

链接如下：http://git.om.dianhun.cn/lihao/caozuo/blob/master/%E6%AD%A6%E7%A5%9E%E8%B5%B5%E5%AD%90%E9%BE%99%E6%96%B0%E5%BC%80%E5%A4%A7%E5%8C%BA%E6%B5%81%E7%A8%8B.md
####4.日常更新，维护
* 更新服务端

更新服务端，就是将新版的服务端配置文件，上传至需要更新的大区中。
这种更新，一般是停服更新，先将所有大区服务关闭，然后通过跳板机将文件更新到制定大区的服务器上的制定目录中，确定文件更新成功后，重新启动服务。这个也是写成脚本进行实现。

停止服务操作（跳板机）：``bash /data/msy/msy_update.sh stop quanhunfu quanhunfu``

开启服务操作（跳板机）：``bash /data/msy/msy_update.sh start quanhunfu quanhunfu``

更新服务端文件（跳板机）：

``bash /data/msy/msy_update.sh ftp``

``bash /data/msy/msy_update.sh ftp_list``

``bash /data/msy/msy_update.sh rsync Meng_kuafuzhan_1.0.24.5/Server_20151223.tar.gz``

``bash /data/msy/msy_update.sh replace list/meng.quanhunfu.ip``

以上是以quanhunfu的Meng_kuafuzhan_1.0.24.5/Server_20151223.tar.gz为例，进行更新。


* 更新表资源
 
这种属于热更新，就是不用关掉服务直接更新。一般是表资源更新。
更新服务端文件（跳板机）：

``bash /data/msy/msy_update.sh ftp``

``bash /data/msy/msy_update.sh ftp_list``

``bash /data/msy/msy_update.sh rsync Meng_kuafuzhan_1.0.24.5/Server_20151223.tar.gz``

``bash /data/msy/msy_update.sh replace list/meng.quanhunfu.ip``

这里的操作步骤与上面的是一样的，区别在与不用停服。

* 更新客户端

客户端更新是将文件上传至CDN上，然后会获取到一个下载链接，提供给产品，用于用户客户端的更新和下载。

执行服务器： 跳板机

**国服客户端更新**

``bash /data/msy/update_client.sh ftp`` 从开发ftp服务器拉取版本文件，分为config目录和热更新资源目录

``bash /data/msy/update_client.sh ftp_list`` 列出所有拉取到本地的版本文件，最新文件在最下面

``bash /data/msy/update_client.sh cdn_list`` 列出梦梦爱三国cdn上所有的目录

``bash /data/msy/update_client.sh cdn mmasg_hunfu meng_client_hunfu_0.0.0.247``
更新meng_client_hunfu_0.0.0.247到cdn的mmasg_hunfu目录

此为热更新文件，热更新文件分发完毕后，再更新版本控制文件
``bash /data/msy/update_client.sh cdn mmasg_hunfu meng_client_hunfu_0.0.0.247_config ``
更新meng_client_hunfu_0.0.0.247_config到cdn的mmasg_hunfu目录；此为版本控制文件

**台服客户端更新**

``bash /data/msy/update_client_twfl.sh ftp``
从开发ftp服务器拉取版本文件，分为config目录和热更新资源目录

``bash /data/msy/update_client_twfl.sh ftp_list``
列出所有拉取到本地的版本文件，最新文件在最下面,同样区分热跟新目录和版本控制呢文件目录

``bash /data/msy/update_client_twfl.sh rsync meng_client_fl_0.0.0.252``
 更新mengclientfl_0.0.0.252文件到rsync服务器并同步至台湾CDN服务器相应目录

``bash /data/msy/update_client_twfl.sh rsync meng_client_fl_0.0.0.252_config``
 更新mengclientfl0.0.0.252config文件到rsync服务器并同步至台湾CDN服务器相应目录



* 维护：停服，重启服务

有时需要单独维护某个大区的制定某个服务，或者停掉某个全部大区，我们需要找到制定大区的IP地址，然后登录到大区中，停掉相应的服务，这个是整体的操作思路，现在由脚本可以实现，直接制定大区和单个服务即可。

执行服务器： 跳板机

执行重启步骤时会调用梦梦爱三国windows服务器中的/data/server/bin/action_area.sh

``bash /data/msy/msy_update.sh stop quanhunfu quanhunfu`` 停止全部全混服大区

``bash /data/msy/msy_update.sh start appstore appstore`` 启动全部appstore大区

``bash /data/msy/msy_update.sh start taiwanfl taiwanfl`` 启动台湾飞流所有大区(飞流即为台服)

``bash /data/msy/msy_update.sh start quanhunfu yuemingxingxi-01`` 启动全混服 月明星稀-01大区

``bash /data/msy/msy_update.sh stop appstore wangmeizhike-01`` 停止appstore 望梅止渴－01大区

``bash /data/msy/msy_update.sh start taiwanfl biyuexiuhua-01`` 启动台湾飞流 闭月羞花－01大区

以上为几个例子。

###以上是几个常见日常更新操作的例子。后续还会慢慢完善补充~
